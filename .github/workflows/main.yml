# Basic workflow to deploy and configure a Linux VM to Azure with the LAMP stack

name: Deployment and Configuration of Azure VM

# Workflow Triggers: On push to main branch or manual execution via the Actions tab.
on:
  # Triggers the workflow on push or pull request events but only for the main branch
#  push:
#    branches: [ main ]

  workflow_dispatch:

jobs:

  # Deploy VM in Azure
  deployVM:
    runs-on: windows-latest
    
    steps:
      # Checkout Code
      - name: Checkout exercise repo
        uses: actions/checkout@v2
        
      - name: Authenticate to Azure
        uses: azure/login@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          enable-AzPSSession: true
      
      - name: Deploy virtual machine in Azure
        uses: azure/powershell@v1
        with:
          azPSVersion: '3.1.0'
          inlineScript: |
            $templateFile = "Templates\azuredeploy.json"
            $parameterFile = "azuredeploy.parameters.json"
            $today=Get-Date -Format "MM-dd-yyyy"
            $deploymentName="VMDeployment-"+"$today"
            New-AzResourceGroupDeployment `
              -ResourceGroupName "VMs_RSG"
              -Name $deploymentName `
              -TemplateFile $templateFile `
              -TemplateParameterFile $parameterFile
